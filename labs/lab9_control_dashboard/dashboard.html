<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ISO 27001 Control Dashboard – Lab 9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1, h2 {
      margin-top: 0;
      color: #f9fafb;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    .card-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .card {
      background: #111827;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      flex: 1 1 220px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    .card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.95rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .card .value {
      font-size: 1.6rem;
      font-weight: 600;
    }
    .card .pill {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .pill-ok { background: #064e3b; color: #bbf7d0; }
    .pill-stale { background: #78350f; color: #fed7aa; }
    .pill-missing { background: #7f1d1d; color: #fecaca; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background: #020617;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    thead {
      background: #0b1120;
    }
    th, td {
      padding: 0.65rem 0.75rem;
      font-size: 0.85rem;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    th {
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
    }
    tbody tr:hover {
      background: rgba(30, 64, 175, 0.3);
    }
    .status-badge {
      display: inline-block;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-ok { background: #065f46; color: #bbf7d0; }
    .status-stale { background: #854d0e; color: #fed7aa; }
    .status-missing { background: #7f1d1d; color: #fecaca; }

    .muted { color: #9ca3af; font-size: 0.8rem; }
    .error { color: #fecaca; margin-top: 1rem; }
    a { color: #60a5fa; }
    @media (max-width: 640px) {
      th:nth-child(4), td:nth-child(4),
      th:nth-child(5), td:nth-child(5) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ISO 27001 Control Dashboard – Lab 9</h1>
    <p class="muted">
      This dashboard is powered by the <code>lab9-control-dashboard</code> Lambda.
      It reads <code>control-dashboard.json</code> from the same S3 prefix and shows
      evidence freshness per control plus a lightweight Security Hub summary.
    </p>

    <div class="card-row" id="summary-cards">
      <!-- Cards populated by JavaScript -->
    </div>

    <h2>Control Evidence Status</h2>
    <table>
      <thead>
        <tr>
          <th>ISO Control</th>
          <th>Control</th>
          <th>Status</th>
          <th>Last Evidence</th>
          <th>Age (days)</th>
        </tr>
      </thead>
      <tbody id="controls-body">
        <!-- Rows populated by JavaScript -->
      </tbody>
    </table>

    <h2 style="margin-top: 2rem;">Security Hub Summary</h2>
    <div class="card-row" id="sh-cards">
      <!-- Security Hub cards populated by JavaScript -->
    </div>

    <p class="muted" id="generated-at"></p>
    <p class="error" id="error"></p>
  </div>

  <script>
    async function loadDashboard() {
      const errorEl = document.getElementById('error');
      const controlsBody = document.getElementById('controls-body');
      const summaryCards = document.getElementById('summary-cards');
      const shCards = document.getElementById('sh-cards');
      const generatedAt = document.getElementById('generated-at');

      try {
        // Fetch JSON from the same prefix as this HTML file
        const resp = await fetch('control-dashboard.json', { cache: 'no-store' });
        if (!resp.ok) {
          throw new Error('Failed to load control-dashboard.json: ' + resp.status);
        }
        const data = await resp.json();

        const controls = Array.isArray(data.controls) ? data.controls : [];
        const shSummary = data.securityhub_summary || {};

        // Summary cards
        const okCount = controls.filter(c => c.status === 'OK').length;
        const staleCount = controls.filter(c => c.status === 'Stale').length;
        const missingCount = controls.filter(c => c.status === 'Missing').length;

        summaryCards.innerHTML = `
          <div class="card">
            <h3>Controls OK</h3>
            <div class="value">${okCount}</div>
            <span class="pill pill-ok">Fresh evidence</span>
          </div>
          <div class="card">
            <h3>Controls Stale</h3>
            <div class="value">${staleCount}</div>
            <span class="pill pill-stale">Evidence older than threshold</span>
          </div>
          <div class="card">
            <h3>Controls Missing</h3>
            <div class="value">${missingCount}</div>
            <span class="pill pill-missing">No evidence objects found</span>
          </div>
          <div class="card">
            <h3>Security Hub Active Findings</h3>
            <div class="value">${shSummary.total_active_findings || 0}</div>
            <span class="pill">from last <code>GetFindings</code> sample</span>
          </div>
        `;

        // Control table
        controlsBody.innerHTML = '';
        controls.forEach(ctrl => {
          const tr = document.createElement('tr');

          let statusClass = 'status-missing';
          if (ctrl.status === 'OK') statusClass = 'status-ok';
          else if (ctrl.status === 'Stale') statusClass = 'status-stale';

          tr.innerHTML = `
            <td>${ctrl.iso_control || ''}</td>
            <td>${ctrl.name || ''}</td>
            <td><span class="status-badge ${statusClass}">${ctrl.status || 'Unknown'}</span></td>
            <td>${ctrl.last_evidence ? new Date(ctrl.last_evidence).toLocaleString() : '—'}</td>
            <td>${typeof ctrl.age_days === 'number' ? ctrl.age_days : '—'}</td>
          `;

          controlsBody.appendChild(tr);
        });

        // Security Hub severity cards
        const bySeverity = shSummary.by_severity || {};
        const severities = Object.keys(bySeverity).sort((a, b) => (bySeverity[b] || 0) - (bySeverity[a] || 0));

        shCards.innerHTML = '';
        if (severities.length === 0) {
          shCards.innerHTML = '<p class="muted">No active Security Hub findings in the sampled window.</p>';
        } else {
          severities.forEach(sev => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <h3>${sev}</h3>
              <div class="value">${bySeverity[sev]}</div>
            `;
            shCards.appendChild(card);
          });
        }

        if (data.generated_at) {
          generatedAt.textContent = `Last generated at ${new Date(data.generated_at).toLocaleString()} from bucket ${data.evidence_bucket}`;
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Error loading dashboard data: ' + err.message;
      }
    }

    loadDashboard();
  </script>
</body>
</html>
